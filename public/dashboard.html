<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<style>
body{
background-image: url('/images/cover.jpg');
background-size:cover;
background-position: center;
background-repeat: no-repeat;
height: 180vh;
}
#internRegistrationForm{
  background-color: rgb(225, 235, 255);
  padding:1rem;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.214);
}



.container {
    margin-top: 50px;
}

.card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    background-color: rgb(246, 246, 246)
}

.card-body {
    text-align: left;
   
}

.card-title {
    font-size: 2.5rem;
    font-family:sans-serif;
    color: #000000;
}

.card-text {
    font-size: 1.5rem;
    color: #2920cb;
    font-family:sans-serif;
    margin-bottom: 20px;
    text-transform: capitalize;
}

#logoutButton {
    background-color: #151515;
    border-color: #000000;
}

#logoutButton:hover {
    background-color: #c82333;
    border-color: #34070c;
}
#btn1{
  background-color: rgb(168, 241, 59);
  
}
#btn1:hover{
  background-color: rgb(139, 199, 49);

}

</style>
</head>
<body>

<div class="container">
<div class="card">
<div class="card-body">
    <h2 class="card-title">Suvidha Foundation</h2>
    <h3 class="card-text">Welcome, <span id="usernamePlaceholder">User</span>!</h3>
    <a href="#" id="logoutButton" class="btn btn-danger" onclick="logout()">Logout</a>
    <div class="col-sm-12 mt-3">
    <a href="/register.html" id="btn1" class="btn ">Register new user</a>
    </div>
    </div>
  </div>

  <br>
  <ul class="nav nav-tabs" id="dashboardTabs">
    <li class="nav-item">
      <a class="nav-link active" id="internRegistrationTab" data-bs-toggle="tab" href="#internRegistration">Intern Registration</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="registeredInternsTab" data-bs-toggle="tab" href="#registeredInterns">Registered Interns</a>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="internRegistration">
      <div class="text-center mb-4"><h3>Registration Form</h3> </div>
      <form id="internRegistrationForm" action="/internRegistration" method="POST" style="max-width: 600px;">
        <div class="mb-3">
          <label for="fullName" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="fullName" required>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email Address</label>
          <input type="email" class="form-control" id="email" required>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="phone" required>
        </div>
        <div class="mb-3">
          <label for="collegeName" class="form-label">College Name</label>
          <input type="text" class="form-control" id="collegeName" required>
        </div>
        <div class="mb-3">
          <label for="highestQualification" class="form-label">Highest Qualification</label>
          <input type="text" class="form-control" id="highestQualification" required>
        </div>
        <div class="mb-3">
          <label for="internshipDomain" class="form-label">Choose Internship Domain</label>
          <select class="form-select" id="internshipDomain" required>
            <option value="Human Resource Management">Human Resource Management</option>
            <option value="Fundraising Coordinator">Fundraising Coordinator</option>
            <option value="Social Media Marketing">Social Media Marketing</option>
            <option value="Business Development">Business Development</option>
            <option value="Data Science">Data Science</option>
            <option value="Machine Learning">Machine Learning</option>
            <option value="Artificial Intelligence">Artificial Intelligence</option>
            <option value="Coding Tutor">Coding Tutor</option>
            <option value="Marketing">Marketing</option>
            <option value="Operations">Operations</option>
            <option value="Web Development">Web Development</option>
            <option value="Social Campaigner">Social Campaigner</option>
            <option value="Public Relations">Public Relations</option>
            <option value="Development">Development</option>
            <option value="Graphic Designer">Graphic Designer</option>
            <option value="Content Writer">Content Writer</option>
            <option value="Digital Marketing">Digital Marketing</option>
            <option value="Capital Campaign">Capital Campaign</option>
            <option value="Community Outreach">Community Outreach</option>
            <option value="Philanthropy">Philanthropy</option>
            <option value="Data Entry">Data Entry</option>
            <option value="Volunteer">Volunteer</option>
            <option value="Summer Internship">Summer Internship</option>
            <option value="Human Resource Recruiter">Human Resource Recruiter</option>
            <option value="Campus Ambassador">Campus Ambassador</option>
            <option value="Social Worker">Social Worker</option>
            <option value="English Tutor">English Tutor</option>
            <option value="Web Development Tutor">Web Development Tutor</option>
            <option value="Trainee Business Analyst">Trainee Business Analyst</option>
            <option value="Facebook Marketing">Facebook Marketing</option>
            <option value="Instagram Marketing">Instagram Marketing</option>
            <option value="LinkedIn Marketing">LinkedIn Marketing</option>
            <option value="YouTube Marketing">YouTube Marketing</option>
            <option value="Event Management">Event Management</option>
            <option value="Mentor">Mentor</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label for="duration" class="form-label">Duration of Internship</label>
          <div class="input-group">
            <select class="form-select" id="duration" required>
              <option value="" disabled selected>Select Duration</option>
              <option value="1 week">1 Week</option>
              <option value="2 weeks">2 Weeks</option>
              <option value="1 month">1 Month</option>
              <option value="2 months">2 Months</option>
              <option value="3 months">3 Months</option>
              <option value="6 months">6 Months</option>
              <option value="custom">Custom</option>
            </select>
            <input type="text" class="form-control" id="customDuration" placeholder="Custom Duration">
          </div>
        </div>
        

        <div class="mb-3">
          <label for="dateOfJoining" class="form-label">Date of Joining</label>
          <input type="date" class="form-control" id="dateOfJoining" required>
        </div>
        <div class="mb-3">
          <label for="dateofcompletion" class="form-label">Date of Completion</label>
          <input type="date" class="form-control" id="dateofcompletion" required>
        </div>
        
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      
    </div>
    <!-- Placeholder for Registered Interns -->
    <div class="tab-pane fade" id="registeredInterns" style="max-height: 380px; overflow-y: auto;"  >
  <h3>Registered Interns</h3>
  <table class="table" >
    <thead>
     
      <tbody id="registeredInternsList" style=" overflow-y: auto;"></tbody>
  </table>
  
</div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
 
// Function to check user login status
function checkLoginStatus() {
  fetch('/checkLoginStatus') // Replace with the actual route to check login status
    .then(response => response.json())
    .then(data => {
      if (!data.loggedIn) {
        // User is not logged in, disable the tabs
        document.getElementById('internRegistrationTab').classList.add('disabled');
        document.getElementById('registeredInternsTab').classList.add('disabled');

        // Optionally, you might want to redirect the user to the login page
        // window.location.href = '/login.html';
      }
    })
    .catch(error => {
      console.error('Error checking login status:', error);
    });
}

  // Fetch the username and update the welcome message
  fetch('/dashboardData')
    .then(response => response.json())
    .then(data => {
      const usernamePlaceholder = document.getElementById('usernamePlaceholder');
      if (usernamePlaceholder) {
        usernamePlaceholder.textContent = data.userData.username;
      }
    })
    .catch(error => {
      console.error('Error fetching dashboard data:', error);
      window.location.href = '/login.html';
    });

  function logout() {
    // Send a request to the logout route
    fetch('/logout')
      .then(response => {
        if (response.redirected) {
         
          window.location.href = response.url;
        }
      })
      .catch(error => {
        console.error('Error during logout:', error);
      });
  }

 
  document.getElementById('logoutButton').addEventListener('click', () => {
    logout();
  });

 
  var dashboardTabs = new bootstrap.Tab(document.getElementById('internRegistrationTab'));
  dashboardTabs.show();


  
  document.getElementById('internRegistrationForm').addEventListener('submit', function (event) {
    event.preventDefault();

    const formData = {
      fullName: document.getElementById('fullName').value,
      email: document.getElementById('email').value,
      phone: document.getElementById('phone').value,
      collegeName: document.getElementById('collegeName').value,
      highestQualification: document.getElementById('highestQualification').value,
      internshipDomain: document.getElementById('internshipDomain').value,
      duration: getDuration(),
      customDuration: document.getElementById('customDuration').value, // Add customDuration to the form data
      dateOfJoining: document.getElementById('dateOfJoining').value,
      dateofcompletion: document.getElementById('dateofcompletion').value,
    };

    fetch('/internRegistration', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData),
    })
      .then(response => response.json())
      .then(data => {
        console.log(data);

        const successMessage = document.createElement('div');
        successMessage.classList.add('alert', 'alert-success');
        successMessage.textContent = 'Registration successful!';

        const formContainer = document.getElementById('internRegistration');
        formContainer.appendChild(successMessage);

        document.getElementById('internRegistrationForm').reset();
      })
      .catch(error => {
        console.error('Error during intern registration:', error);
      });
  });

  function getDuration() {
    const durationSelect = document.getElementById('duration');
    const customDuration = document.getElementById('customDuration');
  
    if (durationSelect && customDuration) {
      const selectedDuration = durationSelect.value;
  
      if (selectedDuration === 'custom') {
        return customDuration.value || '';
      } else {
        return selectedDuration || '';
      }
    }
  
    return '';
  }
  

  fetch('/registeredInternsData')
    .then(response => response.json())
    .then(data => {
      const registeredInternsList = document.getElementById('registeredInternsList');

      registeredInternsList.innerHTML = '';

      const headerRow = document.createElement('tr');
      Object.keys(data.internsData[0]).forEach(key => {
        const headerCell = document.createElement('th');
        headerCell.textContent = key;
        headerRow.appendChild(headerCell);
      });

      const editHeaderCell = document.createElement('th');
      editHeaderCell.textContent = 'Edit';
      headerRow.appendChild(editHeaderCell);

      const sendHeaderCell = document.createElement('th');
      sendHeaderCell.textContent = 'Send';
      headerRow.appendChild(sendHeaderCell);

      registeredInternsList.appendChild(headerRow);
      console.log(Object.keys(data.internsData[0]));

      data.internsData.forEach(intern => {
        const row = document.createElement('tr');

        Object.entries(intern).forEach(([key, value]) => {
          const cell = document.createElement('td');
          
          if (key === 'dateOfJoining' || key === 'dateofcompletion') {
            // Use the formatted date from the server
            cell.textContent = value; // Assuming the server sends formatted dates
          } else {
            cell.textContent = value;
          }
          
          row.appendChild(cell);
        });
        
       

        const editButtonCell = document.createElement('td');
        const editButton = document.createElement('button');
        editButton.textContent = 'Edit';
        editButton.classList.add('btn', 'btn-danger', 'btn-sm');
        editButton.addEventListener('click', () => {
          console.log('Edit button clicked');
          window.location.href = `/editintern.html?id=${intern.id}&fullName=${intern.fullName}&email=${intern.email}&phone=${intern.phone}&collegeName=${intern.collegeName}&highestQualification=${intern.highestQualification}&internshipDomain=${intern.internshipDomain}&duration=${intern.duration}&dateOfJoining=${intern.dateOfJoining}`;
        });
        editButtonCell.appendChild(editButton);
        row.appendChild(editButtonCell);

        const sendButtonCell = document.createElement('td');
        const sendButton = document.createElement('button');
        sendButton.textContent = 'Send';
        sendButton.classList.add('btn', 'btn-success', 'btn-sm');
        sendButton.addEventListener('click', () => {
          const currentDate = new Date();
          const formattedDate = currentDate.toISOString().split('T')[0];
          sendOfferLetter(intern.id,intern.email, formattedDate);
        });
        sendButtonCell.appendChild(sendButton);
        row.appendChild(sendButtonCell);

        registeredInternsList.appendChild(row);
      });
    })
    .catch(error => {
      console.error('Error fetching registered interns data:', error);
    });
   
    function sendOfferLetter(internId, internEmail, formattedDate) {
      const offerLetterEndpoint = `/generateOfferLetter/${internId}`;
    
      fetch(offerLetterEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ internId: internId, formattedDate: formattedDate }),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.blob();
        })
        .then(blob => {
          const fileName = `Offer_Letter_${internId}.pdf`; // Change the extension to .pdf
          const url = window.URL.createObjectURL(new Blob([blob]));
    
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', fileName);
          document.body.appendChild(link);
          link.click();
          link.remove();
    
          const reader = new FileReader();
          reader.onload = () => {
            const offerLetterBlob = reader.result.split(',')[1];
            sendOfferLetterByEmail(internEmail, offerLetterBlob, fileName);
          };
          reader.readAsDataURL(blob);
        })
        .catch(error => {
          console.error('Error sending offer letter:', error);
        });
    }
    
    function sendOfferLetterByEmail(internEmail, offerLetterBlob, fileName) {
      console.log('Sending email to:', internEmail, 'with file:', fileName);
    
      fetch('/sendOfferLetterEmail', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ internEmail, fileName, offerLetterBlob }),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Email sent successfully:', data.message);
          alert('Email sent successfully!');
        })
        .catch(error => {
          console.error('Error sending email:', error);
        });
    }



  function checkLoginStatus() {
    fetch('/dashboardData')
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Invalid response from server');
        }
      })
      .then(data => {
        if (!data.loggedIn) {
          document.getElementById('internRegistrationTab').classList.add('disabled');
          document.getElementById('registeredInternsTab').classList.add('disabled');
        }
      })
      .catch(error => {
        console.error('Error checking login status:', error);
      });
  }

  
</script>

</body>
</html>
